// Regras recomendadas para proteger campos financeiros sensíveis
// Ajuste os caminhos e condições de acordo com seu modelo de usuários e roles.

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Usuários (motoristas) — impede que clientes alterem balance/debt diretamente
    match /users/{userId} {
      allow read: if request.auth != null && request.auth.uid == userId;

      // Permite atualizações parciais feitas pelo próprio usuário, exceto sobre motoristaData financeiro
      allow update: if request.auth != null
        && request.auth.uid == userId
        && !(
          // Bloqueia writes diretos nestes campos
          request.resource.data.keys().hasAny(['motoristaData'])
          && (
            // se tentar modificar balance ou debt, negar
            request.resource.data.motoristaData.balance != resource.data.motoristaData.balance
            || request.resource.data.motoristaData.debt != resource.data.motoristaData.debt
          )
        );

      // Criação e deleção apenas por usuários autenticados (ajuste conforme necessário)
      allow create: if request.auth != null;
      allow delete: if false; // remoção de profiles deve ser feita via backend/admin
    }

    // Corridas/trips — clientes podem criar e atualizar seu próprio documento, mas campos processados
    match /trips/{tripId} {
      allow create: if request.auth != null; // ajuste conforme arquitetura

      allow update: if request.auth != null
        // Usuário que criou a corrida pode atualizar certos campos (ex.: cancelar)
        || request.auth.token.admin == true
        || request.auth.token.backend == true;

      // Impede clientes de marcar processedAt/valor_taxa/valor_motorista diretamente
      allow update: if !(request.resource.data.keys().hasAny(['processedAt','valor_taxa','valor_motorista']));

      allow read: if request.auth != null;
    }

    // Transactions — somente backend (Cloud Functions) deve escrever aqui
    match /transactions/{txId} {
      allow read: if request.auth != null && request.auth.uid != null;
      allow create: if request.auth.token.backend == true || request.auth.token.admin == true;
      allow update, delete: if false;
    }

    // Regras padrão: negar tudo o mais
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

// Observações:
// - `request.auth.token.backend` pode ser definido quando você cria tokens customizados
//   para permitir que seus serviços (Cloud Functions) escrevam em coleções restritas.
// - Se você não usa custom tokens, as Cloud Functions que usam Admin SDK ignoram as regras
//   do Firestore (pois o Admin SDK tem acesso total). Ainda assim, manter regras no cliente
//   limita ações maliciosas a partir de apps móveis.
