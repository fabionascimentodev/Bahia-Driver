// Regras recomendadas para proteger campos financeiros sensíveis
// Ajuste os caminhos e condições de acordo com seu modelo de usuários e roles.

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // -------------------------------------------------
    // Users collection
    // - Users can read their own document
    // - Users can create their own document at users/{uid}
    // - Users can update their own document but cannot change protected financial fields
    // - Deletion must be done by backend/admin
    // -------------------------------------------------
    match /users/{userId} {
      allow read: if request.auth != null && (request.auth.uid == userId || request.auth.token.admin == true || request.auth.token.backend == true);

      // Create only if the requester is the same uid authenticated
      allow create: if request.auth != null && request.auth.uid == userId;

      // Allow updates only by the same user and prevent modification of sensitive fields
      allow update: if request.auth != null
        && request.auth.uid == userId
        // Disallow direct changes to motoristaData.balance or motoristaData.debt from client
        && !(request.resource.data.keys().hasAny(['motoristaData'])
          && (
            // compare existing resource when present - guard against undefined
            (request.resource.data.motoristaData.balance != resource.data.motoristaData.balance)
            || (request.resource.data.motoristaData.debt != resource.data.motoristaData.debt)
          ));

      // Prevent client-side deletes; use Cloud Functions / admin for safe cascaded deletes
      allow delete: if request.auth != null && (request.auth.token.admin == true || request.auth.token.backend == true) == true;
    }

    // -------------------------------------------------
    // Motoristas collection (server / indexed records)
    // - Read allowed to authenticated users
    // - Writes allowed to backend or to the specific user
    // -------------------------------------------------
    match /motoristas/{motoristaId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && (request.auth.uid == motoristaId || request.auth.token.backend == true || request.auth.token.admin == true);
      allow update: if request.auth != null && (request.auth.uid == motoristaId || request.auth.token.backend == true || request.auth.token.admin == true);
      allow delete: if request.auth.token.backend == true || request.auth.token.admin == true;
    }

    // -------------------------------------------------
    // Rides (and subcollections like messages)
    // - Authenticated users may create rides
    // - Reads/updates allowed only for participants or backend
    // - Client cannot modify financial/processed fields
    // -------------------------------------------------
    match /rides/{rideId} {
      allow create: if request.auth != null;

      allow read: if request.auth != null && (
        request.auth.uid == resource.data.passageiroId
        || request.auth.uid == resource.data.motoristaId
        || request.auth.token.admin == true
        || request.auth.token.backend == true);

      allow update: if request.auth != null && (
        request.auth.uid == resource.data.passageiroId
        || request.auth.uid == resource.data.motoristaId
        || request.auth.token.admin == true
        || request.auth.token.backend == true)
        // Disallow clients from directly modifying internal processed fields
        && !(request.resource.data.keys().hasAny(['processedAt','valor_taxa','valor_motorista'])
             && request.auth.token.backend != true && request.auth.token.admin != true);

      // messages subcollection: participants only
      match /messages/{msgId} {
        allow create: if request.auth != null && (
          request.auth.uid == resource.parent.data.passageiroId || request.auth.uid == resource.parent.data.motoristaId || request.auth.token.admin == true || request.auth.token.backend == true);
        allow read: if request.auth != null && (
          request.auth.uid == resource.parent.data.passageiroId || request.auth.uid == resource.parent.data.motoristaId || request.auth.token.admin == true || request.auth.token.backend == true);
      }
    }

    // -------------------------------------------------
    // Support reports: any authenticated user can create; reads by backend/admin or reporter
    // -------------------------------------------------
    match /supportReports/{reportId} {
      allow create: if request.auth != null;
      allow read: if request.auth.token.backend == true || request.auth.token.admin == true || request.auth.uid == resource.data.reporterId;
      allow update, delete: if request.auth.token.backend == true || request.auth.token.admin == true;
    }

    // -------------------------------------------------
    // Transactions: only backend or admin may create
    // -------------------------------------------------
    match /transactions/{txId} {
      allow read: if request.auth != null && request.auth.uid != null;
      allow create: if request.auth.token.backend == true || request.auth.token.admin == true;
      allow update, delete: if false;
    }

    // -------------------------------------------------
    // Generic deny all other paths
    // -------------------------------------------------
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

// Observações:
// - `request.auth.token.backend` pode ser definido quando você cria tokens customizados
//   para permitir que seus serviços (Cloud Functions) escrevam em coleções restritas.
// - Se você não usa custom tokens, as Cloud Functions que usam Admin SDK ignoram as regras
//   do Firestore (pois o Admin SDK tem acesso total). Ainda assim, manter regras no cliente
//   limita ações maliciosas a partir de apps móveis.
